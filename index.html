<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatGram Final</title>
    <!-- –°—Ç–∏–ª–∏ –∏ –ò–∫–æ–Ω–∫–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Gun.js -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    
    <style>
        body { background-color: #0f172a; color: white; height: 100vh; display: flex; flex-direction: column; font-family: sans-serif; }
        
        /* –ß–∞—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 15px; position: relative; animation: fadeIn 0.2s; word-wrap: break-word; }
        .msg-my { background-color: #3b82f6; align-self: flex-end; border-top-right-radius: 2px; }
        .msg-other { background-color: #1e293b; align-self: flex-start; border-top-left-radius: 2px; }
        .msg-user { font-size: 11px; font-weight: bold; margin-bottom: 2px; color: #60a5fa; }
        .msg-time { font-size: 10px; text-align: right; opacity: 0.7; margin-top: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        #input-area { background: #1e293b; padding: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 50; }
        
        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        input[type="text"] { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 20px; outline: none; }
        input[type="text"]:focus { border-color: #3b82f6; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-icon { font-size: 24px; color: #94a3b8; cursor: pointer; padding: 5px; transition: 0.2s; }
        .btn-icon:hover { color: white; }
        .btn-send { background: #3b82f6; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-send:active { transform: scale(0.9); }

        /* –ú–µ–Ω—é —Å–º–∞–π–ª–æ–≤ */
        #emoji-box { display: none; position: absolute; bottom: 70px; left: 10px; background: #1e293b; border: 1px solid #334155; padding: 10px; border-radius: 12px; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 250px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 100; }
        .emoji-item { font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; }
        .emoji-item:hover { background: #334155; }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #login-screen { position: fixed; inset: 0; background: #0f172a; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
    <div id="login-screen">
        <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mb-5 shadow-lg">
            <i class="fa-solid fa-paper-plane text-4xl"></i>
        </div>
        <h2 class="text-2xl font-bold mb-6">–í—Ö–æ–¥ –≤ —á–∞—Ç</h2>
        <input type="text" id="username-input" placeholder="–í–∞—à–µ –∏–º—è..." class="w-64 p-3 bg-slate-800 border border-slate-700 rounded-xl text-center mb-4">
        <button onclick="login()" class="w-64 p-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold">–í–û–ô–¢–ò</button>
    </div>

    <!-- –®–ê–ü–ö–ê -->
    <div class="h-14 bg-[#1e293b] flex items-center px-4 justify-between shadow-md z-10">
        <div class="font-bold text-lg flex items-center gap-2">
            <i class="fa-solid fa-globe text-blue-500"></i> –û–±—â–∏–π –ß–∞—Ç
        </div>
        <div id="status" class="text-xs text-green-400">–û–Ω–ª–∞–π–Ω</div>
    </div>

    <!-- –ß–ê–¢ -->
    <div id="chat-container"></div>

    <!-- –°–ú–ê–ô–õ–´ -->
    <div id="emoji-box"></div>

    <!-- –í–í–û–î -->
    <div id="input-area">
        <i class="fa-regular fa-face-smile btn-icon" onclick="toggleEmoji()"></i>
        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <div class="btn-send" onclick="sendMessage()">
            <i class="fa-solid fa-paper-plane"></i>
        </div>
    </div>

<script>
    // === 1. –ù–ê–°–¢–†–û–ô–ö–ò ===
    const peers = ['https://gun-manhattan.herokuapp.com/gun']; // –û–¥–∏–Ω –Ω–∞–¥–µ–∂–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
    const gun = Gun({ peers: peers });
    const chat = gun.get('chat-final-v1'); // –ò–º—è –∫–æ–º–Ω–∞—Ç—ã

    let username = localStorage.getItem('chat_user') || '';
    const chatContainer = document.getElementById('chat-container');
    const processedIds = new Set(); // –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π

    // === 2. –í–•–û–î ===
    if (username) {
        document.getElementById('login-screen').style.display = 'none';
    }

    function login() {
        const val = document.getElementById('username-input').value.trim();
        if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
        username = val;
        localStorage.setItem('chat_user', val);
        document.getElementById('login-screen').style.display = 'none';
    }

    // === 3. –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ===
    function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text) return;

        const msgData = {
            id: Date.now() + Math.random().toString().slice(2),
            text: text,
            user: username,
            time: Date.now()
        };

        // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É —Å–µ–±—è –°–†–ê–ó–£
        renderMessage(msgData);

        // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å–µ—Ç—å
        chat.set(msgData);

        input.value = '';
        input.focus();
    }

    // === 4. –ü–û–õ–£–ß–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ===
    chat.map().on((msg) => {
        if (!msg || !msg.text || !msg.time) return;
        
        // –ï—Å–ª–∏ —É–∂–µ –≤–∏–¥–µ–ª–∏ —ç—Ç–æ—Ç ID - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if (processedIds.has(msg.id)) return;
        
        // –§–∏–ª—å—Ç—Ä —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (24 —á–∞—Å–∞)
        if (Date.now() - msg.time > 86400000) return;

        renderMessage(msg);
    });

    function renderMessage(msg) {
        if (processedIds.has(msg.id)) return;
        processedIds.add(msg.id);

        const isMe = msg.user === username;
        const date = new Date(msg.time);
        const time = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');

        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'msg-my' : 'msg-other'}`;
        div.dataset.time = msg.time; // –î–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

        div.innerHTML = `
            ${!isMe ? `<div class="msg-user">${msg.user}</div>` : ''}
            <div>${msg.text}</div>
            <div class="msg-time">${time}</div>
        `;

        // –ü—Ä–æ—Å—Ç–∞—è –≤—Å—Ç–∞–≤–∫–∞ –≤ –∫–æ–Ω–µ—Ü (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É, –Ω–æ –ø–æ–∫–∞ —Ç–∞–∫ –Ω–∞–¥–µ–∂–Ω–µ–µ
        chatContainer.appendChild(div);
        
        // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
        setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 50);
    }

    // === 5. –°–ú–ê–ô–õ–ò–ö–ò ===
    const emojis = ['üòÄ','üòÇ','üòç','üò≠','üò°','üëç','üëé','üî•','‚ù§Ô∏è','üí©','ü§°','üëª','üëã','üëÄ','‚úÖ'];
    const emojiBox = document.getElementById('emoji-box');

    emojis.forEach(e => {
        const span = document.createElement('div');
        span.className = 'emoji-item';
        span.innerText = e;
        span.onclick = () => {
            const input = document.getElementById('message-input');
            input.value += e;
            input.focus();
            toggleEmoji(); // –ó–∞–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
        };
        emojiBox.appendChild(span);
    });

    function toggleEmoji() {
        const display = emojiBox.style.display;
        emojiBox.style.display = display === 'grid' ? 'none' : 'grid';
    }

    // –ó–∞–∫—Ä—ã—Ç—å —Å–º–∞–π–ª—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –º–∏–º–æ
    document.addEventListener('click', (e) => {
        if (!emojiBox.contains(e.target) && !e.target.classList.contains('fa-face-smile')) {
            emojiBox.style.display = 'none';
        }
    });

    // Enter = –û—Ç–ø—Ä–∞–≤–∏—Ç—å
    document.getElementById('message-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

</script>
</body>
</html>