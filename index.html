<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatGram Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Gun.js -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/open.js"></script>
    
    <style>
        body { background-color: #0f172a; color: white; height: 100vh; font-family: sans-serif; overflow: hidden; }
        .msg { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 15px; position: relative; animation: pop 0.2s; word-wrap: break-word; }
        .msg-my { background-color: #3b82f6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background-color: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; }
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        /* –ü–∞–Ω–µ–ª—å —Å–º–∞–π–ª–æ–≤ */
        #emoji-panel { display: none; position: absolute; bottom: 70px; left: 10px; right: 10px; background: #1e293b; border: 1px solid #334155; padding: 10px; border-radius: 15px; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 200px; overflow-y: auto; }
        .emoji-btn { font-size: 24px; padding: 5px; cursor: pointer; text-align: center; border-radius: 5px; }
        .emoji-btn:hover { background: #334155; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- 1. –õ–û–ì–ò–ù -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-[#0f172a] flex flex-col items-center justify-center p-4">
        <div class="w-24 h-24 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full flex items-center justify-center mb-6 shadow-2xl">
            <i class="fa-solid fa-shield-cat text-5xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2">ChatGram</h1>
        <p class="text-slate-400 mb-8">Ultimate P2P Network</p>
        
        <input type="text" id="username" placeholder="–í–∞—à –Ω–∏–∫..." class="w-64 p-4 bg-slate-800 border border-slate-700 rounded-xl text-white text-center text-lg outline-none focus:border-blue-500 mb-4">
        <button onclick="login()" class="w-64 p-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition shadow-lg text-lg">–í–û–ô–¢–ò</button>
    </div>

    <!-- 2. –®–ê–ü–ö–ê -->
    <header class="h-14 bg-[#1e293b] border-b border-slate-700 flex items-center px-4 justify-between shrink-0 shadow-md z-20">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center text-lg">üåç</div>
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏ -->
                <div id="net-indicator" class="absolute bottom-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-[#1e293b]" title="–ü–æ–∏—Å–∫ —Å–µ—Ç–∏..."></div>
            </div>
            <div>
                <div class="font-bold text-sm">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</div>
                <div class="text-[10px] text-slate-400" id="peers-count">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
            </div>
        </div>
        <i class="fa-solid fa-rotate-right cursor-pointer text-slate-400 hover:text-white" onclick="window.location.reload()"></i>
    </header>

    <!-- 3. –°–û–û–ë–©–ï–ù–ò–Ø -->
    <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 bg-[#0b1120]">
        <div class="text-center text-xs text-slate-600 py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
    </div>

    <!-- 4. –í–í–û–î -->
    <div class="p-2 bg-[#1e293b] shrink-0 relative z-30">
        <!-- –°–º–∞–π–ª–∏–∫–∏ -->
        <div id="emoji-panel"></div>

        <div class="flex items-end gap-2 bg-[#0f172a] p-2 rounded-2xl border border-slate-700">
            <button onclick="toggleEmoji()" class="text-slate-400 hover:text-yellow-400 p-3 text-xl transition"><i class="fa-regular fa-face-smile"></i></button>
            
            <textarea id="msg-input" rows="1" class="flex-1 bg-transparent text-white outline-none py-3 px-2 resize-none max-h-32 placeholder-slate-500" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            
            <button onclick="send()" class="bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg active:scale-90 transition mb-px">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

<script>
    // === –°–ê–ú–´–ô –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –°–ï–†–í–ï–†–û–í (PEERS) ===
    // –ï—Å–ª–∏ –æ–¥–∏–Ω –ª–µ–∂–∏—Ç, –æ–Ω –ø–æ–π–¥–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π
    const peers = [
        'https://gun-manhattan.herokuapp.com/gun',
        'https://gun-eu.herokuapp.com/gun',
        'https://gun-us.herokuapp.com/gun',
        'https://peer.wallie.io/gun',
        'https://plumm-gun-peer.herokuapp.com/gun',
        'https://gunjs.herokuapp.com/gun' 
    ];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gun
    const gun = Gun({
        peers: peers,
        localStorage: true,
        radisk: true // –õ—É—á—à–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –¥–∏—Å–∫
    });

    const chat = gun.get('chat-ultimate-v1'); // –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞
    
    let user = localStorage.getItem('chat_user') || '';
    const chatBox = document.getElementById('chat-box');
    const processedIds = new Set();

    // === –õ–û–ì–ò–ö–ê –í–•–û–î–ê ===
    if (user) {
        document.getElementById('login-screen').style.display = 'none';
        checkNetwork();
    }

    function login() {
        const val = document.getElementById('username').value.trim();
        if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
        user = val;
        localStorage.setItem('chat_user', val);
        document.getElementById('login-screen').style.display = 'none';
        checkNetwork();
    }

    // –≠–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ç–∏ (Gun –Ω–µ –¥–∞–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞, –Ω–æ –º—ã –ø–æ–∫–∞–∂–µ–º —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º)
    function checkNetwork() {
        setTimeout(() => {
            document.getElementById('net-indicator').classList.replace('bg-red-500', 'bg-green-500');
            document.getElementById('peers-count').innerText = '–í —Å–µ—Ç–∏ (P2P)';
            document.getElementById('peers-count').classList.add('text-green-400');
        }, 1500);
    }

    // === –û–¢–ü–†–ê–í–ö–ê ===
    function send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;

        const msg = {
            id: Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            text: text,
            user: user,
            time: Date.now()
        };

        // 1. –†–µ–Ω–¥–µ—Ä–∏–º —É —Å–µ–±—è –°–†–ê–ó–£ (—á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å —Å–µ—Ç—å)
        renderMessage(msg);

        // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Gun (–≤ –±–∞–∑—É)
        chat.set(msg);

        input.value = '';
        input.style.height = 'auto';
        input.focus();
    }

    // === –ü–û–õ–£–ß–ï–ù–ò–ï ===
    chat.map().on((msg) => {
        if (!msg || !msg.text || !msg.time) return;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        if (processedIds.has(msg.id)) return;
        
        // –§–∏–ª—å—Ç—Ä —Å–æ–≤—Å–µ–º —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π)
        if (Date.now() - msg.time > 259200000) return;

        renderMessage(msg);
    });

    function renderMessage(msg) {
        if (processedIds.has(msg.id)) return;
        processedIds.add(msg.id);

        const isMe = msg.user === user;
        const date = new Date(msg.time);
        const time = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');

        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'msg-my' : 'msg-other'}`;
        div.dataset.time = msg.time;

        div.innerHTML = `
            ${!isMe ? `<div class="text-[11px] font-bold text-blue-400 mb-1">${escapeHtml(msg.user)}</div>` : ''}
            <div class="leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.text)}</div>
            <div class="text-[10px] opacity-60 text-right mt-1 flex justify-end gap-1 items-center">
                ${time} ${isMe ? '<i class="fa-solid fa-check"></i>' : ''}
            </div>
        `;

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ (—á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø–∞–¥–∞–ª–∏ –≤–Ω–∏–∑)
        const children = Array.from(chatBox.children);
        let inserted = false;
        
        if (children.length === 0) {
            chatBox.appendChild(div);
        } else {
            // –ò—â–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ù–û–í–ï–ï –Ω–∞—à–µ–≥–æ, –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –ü–ï–†–ï–î –Ω–∏–º
            for (let i = children.length - 1; i >= 0; i--) {
                const el = children[i];
                if (el.dataset.time && parseInt(el.dataset.time) < msg.time) {
                    // –ù–∞—à–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å—Ç–∞—Ä–µ–µ –Ω–∞—à–µ–≥–æ -> –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –Ω–µ–≥–æ
                    chatBox.insertBefore(div, el.nextSibling);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) chatBox.prepend(div); // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ (–∑–Ω–∞—á–∏—Ç —ç—Ç–æ —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ)
        }

        // –ï—Å–ª–∏ –º—ã –±—ã–ª–∏ –≤–Ω–∏–∑—É, —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
        if (chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 150) {
            setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
        }
    }

    // === –ò–ù–¢–ï–†–§–ï–ô–° ===
    
    // –°–º–∞–π–ª–∏–∫–∏
    const emojis = ['üòÄ','üòÇ','üòç','üò≠','üò°','üëç','üëé','üî•','‚ù§Ô∏è','üíî','üí©','ü§°','üëª','üëΩ','üéÉ','üíÄ','üëÄ','üß†','üí™','üôè','üëã','üíã','üîû','üöÄ','‚úÖ','üõë','üíé','üéÅ','üéà','üéâ'];
    const panel = document.getElementById('emoji-panel');
    
    emojis.forEach(e => {
        const btn = document.createElement('div');
        btn.className = 'emoji-btn';
        btn.innerText = e;
        // onmousedown —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å –Ω–µ —Å–ª–µ—Ç–∞–ª
        btn.onmousedown = (ev) => {
            ev.preventDefault();
            const inp = document.getElementById('msg-input');
            inp.value += e;
            toggleEmoji();
        };
        panel.appendChild(btn);
    });

    function toggleEmoji() {
        const isHidden = getComputedStyle(panel).display === 'none';
        panel.style.display = isHidden ? 'grid' : 'none';
    }

    // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ –ø–æ–ª—è
    const tx = document.getElementById('msg-input');
    tx.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
    });

    // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    tx.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–∞–π–ª–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –º–∏–º–æ
    document.addEventListener('click', (e) => {
        const btn = document.querySelector('.fa-face-smile').parentNode;
        if (!panel.contains(e.target) && !btn.contains(e.target)) {
            panel.style.display = 'none';
        }
    });

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
</script>
</body>
</html>
